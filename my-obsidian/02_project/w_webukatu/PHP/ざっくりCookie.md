## 目次

- Cookieの概要
- Cookieの種類
	- ファストCookie
	- サードパーティCookie
	- JS Cookie
	- セッションCookie
	- 永続Cookie
- Cookieを使う目的
- LocalStrageとCookieの違い
- キャッシュとCookieの違い
- Cookieのメリット
- Cookieのデメリット
- Cookieの使い方
- 参考

## Cookieの概要
---
Cookieとは、ちょっとした情報をWebブラウザに保存しておける「仕組み」のこと。
Cookieにはいろいろな情報を保存しておくことができる。


例えば、

- ログイン情報などの認証情報
- ユーザーの会員情報（ユーザー名やメールアドレス）
- ECカートの中身
- ユーザーのPC環境

などを保存しておく。


Cookieには保持する期限をつけることができるので、一度ブラウザを閉じても情報が保存したままにできる。

Cookieは「Webサーバー」が発行する（正確にはWebサーバーのHTTPレスポンス内で発行される）。

 

## Cookieの種類
---

Cookieにはいくつか種類がある。
それぞれ下記に解説する。


### ファストCookieとサードパーティCookie

Cookieの「発行元」によって種類が分類される。



#### ファーストCookie（1st place Cookie）

ユーザーが訪問したWebサイトのドメインが発行するCookieのこと。
つまり、発行元は「自分が訪問したWebサイトのWebサーバー」である。

ファーストCookieの使用目的は「Webアプリケーションを成立させる」ため。
ログイン状態や、セッション管理、言語やテーマ設定などがブラウザに保存できていないと、
ログインができなくなったり、正常にアプリケーションが使えなくなったりする。

HTTPはステートレス（記憶力ゼロ）。
ファーストCookieがないと、ページを移動するたびにログインせねばならなかったり、
設定が毎回リセットされたり、誰が誰だかわからないという状態になってしまう。
なので、一時的な状態管理として（Sessionと合わせて用いて）、情報を保存しておく。



#### サードパーティCookie（3rd place Cookie）

ユーザーが訪問したWebサイトとは異なるドメインから発行されるCookieのこと。
つまり、発行元は「自分が訪問したWebサイトでないWebサイトのWebサーバー」である。

サードパーティCookieの使用目的は「より収益をあげる」ため。
つまり「マーケティング」のために使われる。



### JS Cookie

jsを使ってCookieに情報を保存することができる。
厳密には「document.cookie」というAPIを使ってCookieに情報を書き込む。

#### set-cookieとjs-cookieの違い

**set-cookie**
- 実行場所：サーバーサイド（バックエンド）
- 主な用途：認証トークン、セッションIDの付与
- セキュリティ性：高い
- 仕組み：HTTPレスポンスヘッダー

**js-cookie**
- 実行場所：クライアントサイド（ブラウザ）
- 主な用途：UI設定、一時的なデータ保存
- セキュリティ：低い（XSS攻撃で盗まれるリスクあり）
- 仕組み：document.cookieのラッパーライブラリ



### セッションCookie

セッションCookieとは「ブラウザを開いている間だけ有効な、一時的なクッキー」のこと。

ブラウザを閉じると自動的に削除されるため、データを長期保存するのには向かない。

セキュリティや「その場限りの状態維持」に適している。

保存場所はメモリ。



### 永続Cookie

セッションCookieと反対で「ブラウザを閉じても有効で、有効期限が設定されているクッキー」のこと。

サーバーがCookieを発行する際、一緒に「いつまで保存するか」を指定する。

設定された期限が来るか、ユーザーが手動で履歴削除を行うまで情報は残り続ける。

保存場所はストレージ（HDD/SSD）。




## Cookieを使う目的
---

Cookieは主に以下の3つの用途で使われる。

1. セッション管理
2. パーソナライズ
3. トラッキング


### セッション管理

冒頭にも書いたが、HTTPはステートレスなプロトコルのため、状態を保持しておくことができない。

そのため、Cookieは「Webサイトに記憶を持たせる」ことが一番の目的である。

ログイン状態を維持したり、ショッピングカートに何を入れたかを記憶するために使われる。

もし、Cookieがなかったら、ページを移動するたびに、毎回ログインIDとパスワードを入力しなければならない。



### パーソナライズ

ユーザーごとの好みや設定を保存して、使い勝手をよくするためにも使われる。ダークモードや文字サイズ、言語などの選択状態を保存する。

もし、Cookieがなかったら、サイトにアクセスするたびに、毎回ダークモードに切り替えたり、言語を選びなおしたりする必要がある。



### トラッキング

ユーザーが「どのページを見たか」を記録し、マーケティングに活用する。

GoogleAnalyticsなどでのアクセス解析やリターゲティング広告（あるECサイトでスニーカーを見たら、別のニュースサイトを見ているときにそのスニーカーが出る仕組み）に使われる。


## LocalStrageとCookieの違い
---

どちらも「ブラウザにデータを保存する」という役割だが、「保存したデータを誰が使うのか」が大きく異なる。

- Cookie：毎回サーバーに送る
- localStorage：ブラウザ内で完結

localStorage は js が読み出さない限り、ブラウザの中に保持される。


保存できる容量も異なる。

- Cookie：4KB
- localStorage：5MB以上（ブラウザにより異なる）


使い分けは

- Cookie：サーバーが知る必要がある情報
	- 認証トークン
	- セッションID　など

- localStorage：サーバーは知らなくて良い、情報表示のための情報
	- UIの設定
	- 入力フォームの一時保存
	- カート情報（ログイン前）　など


## キャッシュとCookieの違い
---

どちらもブラウザにデータを保存する機能だが、

- 保存する目的
- 保存する中身

が大きく異なる。

- Cookie：何を記録したかを記録する
- キャッシュ：コピーを保管する

#### Cookie

- 主な目的：状態の維持
- 中身：文字情報（ID、設定値）
- 容量：かなり小さい（4KB程度）
- サーバーとの関係：毎回サーバーに送信する
- 有効期限：サイト側が指定


#### キャッシュ

- 主な目的：表示の高速化
- 中身：ファイルそのもの（画像、CSS、HTML）
- 容量：非常に大きい（数百MG〜数GB）
- サーバーとの関係：サーバーからもらわないために使う
- 有効期限： サイト側の指定＋ブラウザの判断


キャッシュは、一度DLした思いファイルを、PCやスマホ内に保存しておき、2回目に以降の表示を早くする機能。

具体的には、サイトのロゴやら背景デザインやら動作プログラムなど。

毎回変更されるものではないので、毎回サーバーからDLするのは無駄。



## Cookieのメリット
---

Cookieを導入する主なメリットは以下の通り。

- サーバーへの自動送信機能がある
- jsから隠すことができる
- 有効期限を自動管理できる


#### サーバーへの自動送信機能がある

ブラウザは対象のドメインへのリクエスト（ページ遷移、Ajax通信、画像読み込みなど）のたびに、自動的にCookieをHTTPヘッダーに含めて送信する。

フロントエンドで「トークンをヘッダーにセットする処理」を書く必要がなくなり、サーバー側でのセッションチェックや認証がスムーズになる。



#### jsから隠すことができる

HttpOnly属性を付与することができる。

この属性が付与されると、jsからCookieにアクセスができなくなるため、万が一、サイトにXSSの脆弱性があっても、攻撃者に認証トークンを盗まれるリスクを劇的に下げることができる。

localStorageではできない。



#### 有効期限を自動管理できる

`Expires` や `Max-Age` を設定できる。

30分でログアウトさせたり、30日間ログインを維持するといった制御をブラウザに任せることができる。期限が来たらブラウザが勝手に削除してくれる。



## Cookieのデメリット
---

Cookieのデメリットは以下の通り。

- 保存できる容量が小さい
- 通信パフォーマンスへの悪影響（オーバーヘッド）
- セキュリティリスク（CSRF）
- プライバシー規制（GDPR, ITP）


#### 保存できる容量が小さい

Cookieは1つにつき4KB（約4096バイト）までしか保存できない。

長い文章やら複雑なJSONデータ、大量の設定情報などは保存できない。


#### 通信パフォーマンスへの悪影響（オーバーヘッド）

リクエストのたびに毎回サーバーへ送信されるため、全ての通信が重くなる。スマホ回線だと影響が大きいかも。


#### セキュリティリスク（CSRF）

サーバーに「自動送信される」というメリットが仇になる。

CSRF（クロスサイトリクエストフォージェリ）という攻撃のリスクが生じる。


CSRFとは、簡単にいうと、

**「Webアプリケーション利用者自身が意図しない処理」が実行されてしまう「脆弱性または攻撃手法」のこと**

である（詳しくは [[ざっくりセキュリティ]] を参照）。

現在は「sameSite属性」の設定でかなり防げるようになったらしいが、引き続き対策は必須。



#### プライバシー規制（GDPR, ITP）

ユーザー追跡にCookieが使われるため、世界的に規制が強化されている。

サイト下部に「Cookieを許可しますか？」という同意ポップアップを実装する必要がある（特にEU圏）。また、AppleのITP（Intelligent Tracking Prevention）機能により、訪問から24時間〜7日でCookieが強制削除される場合があり、長期的なログイン維持などが難しくなってきている。




## Cookieの使い方
---

バニラjs、js-cookie、バックエンドでの使い方がある。
長くなるので今回はスキップ。

詳細は [[Cookieの使い方]] を参照。





## 参考
---

HTTP Cookieの使用（MDN）
https://developer.mozilla.org/ja/docs/Web/HTTP/Guides/Cookies

